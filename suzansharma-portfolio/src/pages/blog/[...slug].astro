---
import Layout from '../../layouts/BlogLayout.astro';
import { getAllBlogPosts, getPostBySlug, getAllCategories } from '../../lib/blog/getPosts';
import { marked } from 'marked';
import AdUnit from '../../components/blog/AdUnit.astro';
import RelatedPosts from '../../components/blog/RelatedPosts.astro';
import BlogTOC from '../../components/blog/BlogTOC.astro';

export async function getStaticPaths() {
  const allPosts = getAllBlogPosts();
  return allPosts.map(post => ({
    params: { slug:  post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const allPosts = getAllBlogPosts();
const relatedPosts = allPosts
  .filter(p => p.category === post.category && p.slug !== post.slug)
  .slice(0, 3);

const htmlContent = await marked(post.content);
---

<Layout title={post.title} description={post.description}>
  <!-- ‚úÖ AI Schema Markup -->
  <script type="application/ld+json" set:html={JSON.stringify(post.aiSchema)} />

  <article class="max-w-4xl mx-auto px-4 py-20">
    <!-- Header -->
    <header class="mb-12">
      <!-- Category & Meta -->
      <div class="flex items-center gap-3 mb-4">
        <span class="px-3 py-1 bg-cyan-400/20 text-cyan-300 rounded-full text-sm capitalize">
          {post.category}
        </span>
        <span class="text-gray-500 text-sm">{post.readingTime} min read</span>
      </div>

      <!-- Title -->
      <h1 class="text-5xl font-bold mb-6 neon-glow">
        {post.title}
      </h1>

      <!-- Description -->
      <p class="text-lg text-gray-300 mb-6">
        {post.description}
      </p>

      <!-- Meta Info -->
      <div class="flex items-center justify-between text-gray-500 text-sm pb-6 border-b border-gray-800">
        <div class="flex gap-6">
          <span>üìÖ {new Date(post.date).toLocaleDateString()}</span>
          <span>‚úçÔ∏è By {post.author}</span>
        </div>
      </div>
    </header>

    <!-- Cover Image -->
    {post.cover && (
      <img
        src={post.cover}
        alt={post.title}
        class="w-full rounded-2xl mb-12 h-96 object-cover border border-gray-800"
      />
    )}

    <!-- ‚úÖ ADS (Top of Content) -->
    <div class="mb-12">
      <AdUnit position="before-content" />
    </div>

    <!-- Table of Contents -->
    <BlogTOC content={post.content} />

    <!-- Main Content -->
    <div class="prose prose-invert max-w-none mb-12" set:html={htmlContent} />

    <!-- ‚úÖ ADS (Middle of Content) -->
    <div class="my-12">
      <AdUnit position="middle-content" />
    </div>

    <!-- AI Summary Box -->
    {post.aiSummary && (
      <div class="glass p-6 rounded-2xl mb-12 border-l-4 border-cyan-400">
        <h3 class="font-bold mb-2">Quick Summary</h3>
        <p class="text-gray-300 text-sm">{post.aiSummary}</p>
      </div>
    )}

    <!-- AI Keywords -->
    {post.aiKeywords && post.aiKeywords.length > 0 && (
      <div class="mb-12">
        <h3 class="font-bold mb-4">Key Topics</h3>
        <div class="flex flex-wrap gap-2">
          {post.aiKeywords.map(keyword => (
            <span class="px-4 py-2 bg-cyan-400/10 border border-cyan-400/30 rounded-full text-sm">
              {keyword}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- ‚úÖ ADS (After Content) -->
    <div class="my-12">
      <AdUnit position="after-content" />
    </div>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="py-12 border-t border-gray-800">
        <h2 class="text-2xl font-bold mb-8">Related Articles</h2>
        <RelatedPosts posts={relatedPosts} />
      </section>
    )}

    <!-- CTA Section -->
    <div class="glass p-8 rounded-2xl mt-12 text-center">
      <h3 class="text-2xl font-bold mb-4">Ready to Transform Your Tourism Brand?</h3>
      <p class="text-gray-300 mb-6">Get a free consultation on your growth strategy.</p>
      <a href="/contact" class="neon-button">
        Book a Free Consultation
      </a>
    </div>
  </article>
</Layout>